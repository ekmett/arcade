<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Arcade/Server.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE QuasiQuotes #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE OverloadedStrings #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE TemplateHaskell #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE GADTs #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE DeriveDataTypeable #-}</span>
<a name="line-11"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-conid'>Server</span>
<a name="line-12"></a>  <span class='hs-layout'>(</span> <span class='hs-varid'>serverMain</span>
<a name="line-13"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>E</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span>
<a name="line-20"></a><span class='hs-cpp'>#ifdef EMBED</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>FileEmbed</span>
<a name="line-22"></a><span class='hs-cpp'>#endif</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TIO</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Wai</span><span class='hs-varop'>.</span><span class='hs-conid'>Application</span><span class='hs-varop'>.</span><span class='hs-conid'>Static</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>WebSockets</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>WS</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Wai</span><span class='hs-varop'>.</span><span class='hs-conid'>Handler</span><span class='hs-varop'>.</span><span class='hs-conid'>WebSockets</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>WaiWS</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Wai</span><span class='hs-varop'>.</span><span class='hs-conid'>Handler</span><span class='hs-varop'>.</span><span class='hs-conid'>Warp</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Warp</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Process</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Filesystem</span><span class='hs-varop'>.</span><span class='hs-conid'>Path</span><span class='hs-varop'>.</span><span class='hs-conid'>CurrentOS</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Path</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-conid'>Connection</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Arcade</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-conid'>Monitor</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-conid'>Options</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="registerConnection"></a><span class='hs-definition'>registerConnection</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-conid'>Connection</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-38"></a><span class='hs-definition'>registerConnection</span> <span class='hs-sel'>_r</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-39"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="threadCountG"></a><span class='hs-definition'>threadCountG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span>
<a name="line-42"></a><span class='hs-definition'>threadCountG</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"thread count"</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="serverMain"></a><span class='hs-definition'>serverMain</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Options</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Monitor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-45"></a><span class='hs-definition'>serverMain</span> <span class='hs-varid'>opts</span> <span class='hs-varid'>mon</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>uri</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>serverUri</span> <span class='hs-varid'>opts</span>
<a name="line-47"></a>  <span class='hs-varid'>putStrLn</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Serving "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>uri</span>
<a name="line-48"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>opts</span><span class='hs-varop'>^.</span><span class='hs-varid'>serverOpen</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-49"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>system</span> <span class='hs-varop'>$</span> <span class='hs-str'>"/usr/bin/open "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>uri</span>
<a name="line-50"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-51"></a>  <span class='hs-conid'>Warp</span><span class='hs-varop'>.</span><span class='hs-varid'>runSettings</span>
<a name="line-52"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>Warp</span><span class='hs-varop'>.</span><span class='hs-varid'>setPort</span> <span class='hs-layout'>(</span><span class='hs-varid'>opts</span><span class='hs-varop'>^.</span><span class='hs-varid'>serverPort</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Warp</span><span class='hs-varop'>.</span><span class='hs-varid'>setTimeout</span> <span class='hs-layout'>(</span><span class='hs-varid'>opts</span><span class='hs-varop'>^.</span><span class='hs-varid'>serverTimeout</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Warp</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultSettings</span><span class='hs-layout'>)</span>
<a name="line-53"></a>    <span class='hs-varop'>$</span> <span class='hs-conid'>WaiWS</span><span class='hs-varop'>.</span><span class='hs-varid'>websocketsOr</span> <span class='hs-conid'>WS</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultConnectionOptions</span> <span class='hs-layout'>(</span><span class='hs-varid'>app</span> <span class='hs-varid'>mon</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-varop'>$</span> <span class='hs-varid'>staticApp</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>opts</span><span class='hs-varop'>^.</span><span class='hs-varid'>serverStaticPath</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-cpp'>#ifdef EMBED</span>
<a name="line-57"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>embeddedSettings</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>embedDir</span> <span class='hs-str'>"static"</span><span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-cpp'>#else</span>
<a name="line-59"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defaultFileServerSettings</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Path</span><span class='hs-varop'>.</span><span class='hs-varid'>decodeString</span> <span class='hs-str'>"static"</span>
<a name="line-60"></a><span class='hs-cpp'>#endif</span>
<a name="line-61"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defaultFileServerSettings</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Path</span><span class='hs-varop'>.</span><span class='hs-varid'>decodeString</span> <span class='hs-varid'>xs</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="Hangup"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Hangup</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Hangup</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-64"></a><a name="instance%20Exception%20Hangup%20app%20::%20Monitor%20-%3e%20ServerApp%20app%20mon%20pending%20=%20countThread%20mon%20%22websocket%22%20$%20do%20let%20rhead%20=%20pendingRequest%20pending%20rpath%20=%20requestPath%20rhead%20putStrLn%20$%20%22connection%20via%20%22%20++%20show%20rpath%20conn%20%3c-%20WS.acceptRequest%20pending%20--%20TODO:%20coin%20a%20UUID%20for%20this%20connecton,%20or%20take%20it%20from%20the%20URL%20WS.sendTextData%20conn%20(%220%22::Text)%20input%20%3c-%20newChan%20output%20%3c-%20newChan%20receiverId%20%3c-%20forkR%20mon%20%22websocket.read%22%20$%20handle%20(%5cHangup%20-%3e%20return%20())%20$%20forever%20$%20do%20msg%20%3c-%20WS.receiveData%20conn%20writeChan%20input%20msg%20print%20msg%20senderId%20%3c-%20myThreadId%20registerConnection%20$%20Connection%20%7b%20Arcade.send%20=%20writeChan%20output%20,%20Arcade.recv%20=%20readChan%20input%20,%20Arcade.close%20=%20throwTo%20senderId%20Hangup%20%7d%20whereException%20%22websocket.write%22%20$%20finally%20??%20throwTo%20receiverId%20Hangup%20$%20do%20forever%20$%20do%20msg%20%3c-%20readChan%20output%20WS.sendTextData%20conn%20msg%20countThread%20::%20Monitor%20-%3e%20Text%20-%3e%20IO%20a%20-%3e%20IO%20a%20countThread%20mon%20nm%20a%20=%20do%20tG%20%3c-%20gauge%20threadCountG%20mon%20whereException%20nm%20.%20E.bracket_%20(inc%20tG)%20(dec%20tG)%20$%20a%20forkR%20::%20Monitor%20-%3e%20Text%20-%3e%20IO%20()%20-%3e%20IO%20ThreadId%20forkR%20mon%20nm%20a%20=%20do%20tG%20%3c-%20gauge%20threadCountG%20mon%20forkIO%20.%20whereException%20nm%20.%20E.bracket_%20(inc%20tG)%20(dec%20tG)%20$%20a%20whereException%20::%20Text%20-%3e%20IO%20a%20-%3e%20IO%20a%20whereException%20w%20=%20handling%20id%20$%20%5ce%20-%3e%20do%20TIO.putStrLn%20(T.concat%20%5b%22Exception%20in%20%22,%20w,%20%22:%20%22,%20T.pack%20$%20show%20e%5d)%20E.throw%20e"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Exception</span> <span class='hs-conid'>Hangup</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="app"></a><span class='hs-definition'>app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monitor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ServerApp</span>
<a name="line-67"></a><span class='hs-definition'>app</span> <span class='hs-varid'>mon</span> <span class='hs-varid'>pending</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>countThread</span> <span class='hs-varid'>mon</span> <span class='hs-str'>"websocket"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-68"></a>
<a name="line-69"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>rhead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pendingRequest</span> <span class='hs-varid'>pending</span>
<a name="line-70"></a>      <span class='hs-varid'>rpath</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>requestPath</span> <span class='hs-varid'>rhead</span>
<a name="line-71"></a>
<a name="line-72"></a>  <span class='hs-varid'>putStrLn</span> <span class='hs-varop'>$</span> <span class='hs-str'>"connection via "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>rpath</span>
<a name="line-73"></a>
<a name="line-74"></a>
<a name="line-75"></a>  <span class='hs-varid'>conn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>WS</span><span class='hs-varop'>.</span><span class='hs-varid'>acceptRequest</span> <span class='hs-varid'>pending</span>
<a name="line-76"></a>
<a name="line-77"></a>  <span class='hs-comment'>-- TODO: coin a UUID for this connecton, or take it from the URL</span>
<a name="line-78"></a>  <span class='hs-conid'>WS</span><span class='hs-varop'>.</span><span class='hs-varid'>sendTextData</span> <span class='hs-varid'>conn</span> <span class='hs-layout'>(</span><span class='hs-str'>"0"</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a>  <span class='hs-varid'>input</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newChan</span>
<a name="line-81"></a>  <span class='hs-varid'>output</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newChan</span>
<a name="line-82"></a>
<a name="line-83"></a>  <span class='hs-varid'>receiverId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkR</span> <span class='hs-varid'>mon</span> <span class='hs-str'>"websocket.read"</span> <span class='hs-varop'>$</span>
<a name="line-84"></a>    <span class='hs-varid'>handle</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-conid'>Hangup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-85"></a>    <span class='hs-varid'>forever</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-86"></a>      <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>WS</span><span class='hs-varop'>.</span><span class='hs-varid'>receiveData</span> <span class='hs-varid'>conn</span>
<a name="line-87"></a>      <span class='hs-varid'>writeChan</span> <span class='hs-varid'>input</span> <span class='hs-varid'>msg</span>
<a name="line-88"></a>      <span class='hs-varid'>print</span> <span class='hs-varid'>msg</span>
<a name="line-89"></a>
<a name="line-90"></a>  <span class='hs-varid'>senderId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>myThreadId</span>
<a name="line-91"></a>
<a name="line-92"></a>  <span class='hs-varid'>registerConnection</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Connection</span>
<a name="line-93"></a>    <span class='hs-layout'>{</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-varid'>send</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeChan</span> <span class='hs-varid'>output</span>
<a name="line-94"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-varid'>recv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readChan</span> <span class='hs-varid'>input</span>
<a name="line-95"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Arcade</span><span class='hs-varop'>.</span><span class='hs-varid'>close</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwTo</span> <span class='hs-varid'>senderId</span> <span class='hs-conid'>Hangup</span>
<a name="line-96"></a>    <span class='hs-layout'>}</span>
<a name="line-97"></a>
<a name="line-98"></a>  <span class='hs-varid'>whereException</span> <span class='hs-str'>"websocket.write"</span> <span class='hs-varop'>$</span>
<a name="line-99"></a>    <span class='hs-varid'>finally</span> <span class='hs-varop'>??</span> <span class='hs-varid'>throwTo</span> <span class='hs-varid'>receiverId</span> <span class='hs-conid'>Hangup</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-100"></a>      <span class='hs-varid'>forever</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-101"></a>        <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readChan</span> <span class='hs-varid'>output</span>
<a name="line-102"></a>        <span class='hs-conid'>WS</span><span class='hs-varop'>.</span><span class='hs-varid'>sendTextData</span> <span class='hs-varid'>conn</span> <span class='hs-varid'>msg</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="countThread"></a><span class='hs-definition'>countThread</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monitor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-105"></a><span class='hs-definition'>countThread</span> <span class='hs-varid'>mon</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-106"></a>  <span class='hs-varid'>tG</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gauge</span> <span class='hs-varid'>threadCountG</span> <span class='hs-varid'>mon</span>
<a name="line-107"></a>  <span class='hs-varid'>whereException</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>.</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-varid'>bracket_</span> <span class='hs-layout'>(</span><span class='hs-varid'>inc</span> <span class='hs-varid'>tG</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dec</span> <span class='hs-varid'>tG</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>a</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="forkR"></a><span class='hs-definition'>forkR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monitor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ThreadId</span>
<a name="line-110"></a><span class='hs-definition'>forkR</span> <span class='hs-varid'>mon</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-111"></a>  <span class='hs-varid'>tG</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gauge</span> <span class='hs-varid'>threadCountG</span> <span class='hs-varid'>mon</span>
<a name="line-112"></a>  <span class='hs-varid'>forkIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>whereException</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>.</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-varid'>bracket_</span> <span class='hs-layout'>(</span><span class='hs-varid'>inc</span> <span class='hs-varid'>tG</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dec</span> <span class='hs-varid'>tG</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>a</span>
<a name="line-113"></a>
<a name="line-114"></a><a name="whereException"></a><span class='hs-definition'>whereException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-115"></a><span class='hs-definition'>whereException</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>handling</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-116"></a>  <span class='hs-conid'>TIO</span><span class='hs-varop'>.</span><span class='hs-varid'>putStrLn</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"Exception in "</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-str'>": "</span><span class='hs-layout'>,</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-117"></a>  <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-varid'>throw</span> <span class='hs-varid'>e</span>
</pre></body>
</html>
